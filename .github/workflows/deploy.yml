name: Node CI (Azure VM)
env:
  PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  issues: write
  packages: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Azure
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 400 private_key
          ssh -o StrictHostKeyChecking=no -i private_key hd@20.226.119.146 '
          source /home/hd/.nvm/nvm.sh
          source /home/hd/.bashrc
          nvm use node

          DIR=/home/hd/base-nest-api
          if [ ! -d $DIR ]
            then
              git clone https://github.com/gabrielmaialva33/base-nest-api.git $DIR
          else
            echo "Directory $DIR already exists"
          fi

          cd $DIR
          rm -rf $DIR/dist
          git checkout main && git fetch --all && git reset --hard origin/main && git pull origin main

          # Install dependencies, build
          pnpm install && pnpm db:migrate && pnpm build

          # Check if the app is running and kill it
          if [ $(tmux ls | grep -c "base-nest-api") -eq 1 ]
            then
              tmux kill-session -t base-nest-api
              echo "Session killed. ğŸ—¡ï¸"
          else
            echo "No session to kill. ğŸ¤·"
          fi

          # Start the app
          tmux new-session -d -s base-nest-api 'pnpm start:prod'
          echo "Session started. ğŸš€"

          # Check if the app is running
          if [ $(tmux ls | grep -c "base-nest-api") -eq 1 ]
              then
              echo "App is running. âœ…"
          else
              echo "App is not running. âŒ"
              exit 1
          fi

          echo "Deployed successfully. ğŸ‰"
          exit 0
          '
